<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Report An Incident</title>
  <style>
/* ===== Reset & Base Styles ===== */
*, *::before, *::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 40px 20px 40px;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f0f3f2;
  color: #2e3e2f;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1.6;
}


/* ===== Layout ===== */
main {
  background: #fff;
  max-width: 880px;
  width: 100%;
  padding: 40px;
  border-radius: 16px;
  box-shadow: 0 10px 28px rgba(0, 0, 0, 0.06);
  margin: auto;
}

/* ===== Typography ===== */
header h1 {
  font-weight: 600;
  color: #2a4d3a;
  text-align: center;
  margin-bottom: 0.5rem;
  letter-spacing: 0.04em;
}

section {
  font-size: 1rem;
  color: #3e4e3f;
}

header h1 {
  font-size: 2.0rem;
  margin-bottom: 0.75rem;
}

section h2 {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
}

/* ===== Buttons ===== */
button,
input[type="submit"],
#retakeBtn,
#logoutBtn,
#captureBtn {
  border: none;
  border-radius: 5px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.3s ease, transform 0.15s ease, box-shadow 0.3s ease;
}

/* Report Button */
#reportBtn {
  background: #3a7d44;
  color: white;
  padding: 12px 32px;
  letter-spacing: 0.05em;
  box-shadow: 0 4px 12px rgba(58, 125, 68, 0.3);
}

#reportBtn:hover {
  background: #2a5931;
  transform: translateY(-2px);
}

/* Logout Button */
.logout-btn {
  background: #f44336;
  color: white;
  padding: 12px 28px;
  align-self: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.logout-btn:hover {
  background: #d32f2f;
  transform: translateY(-2px);
}

/* ===== Modal ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background-color: rgba(42, 77, 58, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  padding: 32px 20px;
  z-index: 1000;
  backdrop-filter: blur(4px);
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: #fff;
  border-radius: 16px;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  padding: 36px 32px;
  position: relative;
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
}

.modal h2 {
  font-size: 1.7rem;
  font-weight: 700;
  color: #3a7d44;
  text-align: center;
  margin-bottom: 30px;
}

.close-modal-btn {
  position: absolute;
  top: 14px;
  right: 20px;
  background: none;
  border: none;
  font-size: 1.8rem;
  color: #3a7d44;
  cursor: pointer;
}

.close-modal-btn:hover {
  color: #1f3a2a;
}

/* ===== Form Styles ===== */
form {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

form label {
  font-weight: 600;
  font-size: 0.95rem;
  color: #4a5e4a;
  margin-bottom: 6px;
}

input[type="text"],
textarea {
  padding: 12px 14px;
  border-radius: 10px;
  border: 1.5px solid #cbd5d1;
  width: 100%;
  font-size: 1rem;
  background: #fdfdfd;
  transition: border 0.3s ease, box-shadow 0.3s ease;
}

input:focus,
textarea:focus {
  border-color: #3a7d44;
  box-shadow: 0 0 8px rgba(58, 125, 68, 0.3);
  outline: none;
}

input[readonly] {
  background: #f4f7f5;
  color: #6b7a6a;
}

form button[type="submit"] {
  background: #3a7d44;
  color: white;
  padding: 14px;
  margin-top: 10px;
  border-radius: 30px;
  box-shadow: 0 4px 14px rgba(58, 125, 68, 0.35);
}

form button[type="submit"]:hover {
  background: #2a5931;
  transform: translateY(-2px);
}

/* ===== Capture Image Area ===== */
video,
img {
  width: 100%;
  max-width: 300px;
  max-height: 300px;
  object-fit: cover;
  border-radius: 12px;
  display: block;
  margin-bottom: 10px;
}

#captureBtn,
#retakeBtn {
  background: #3a7d44;
  color: white;
  padding: 12px 36px;
  font-weight: 700;
  font-size: 1rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  border-radius: 28px;
  user-select: none;
  margin-right: 10px;
  box-shadow: 0 4px 12px rgba(58, 125, 68, 0.4);
}

#retakeBtn {
  background: #607d3b;
}

#captureBtn:hover,
#retakeBtn:hover,
#captureBtn:focus,
#retakeBtn:focus {
  background: #2a5931;
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(42, 89, 49, 0.5);
}

#captureBtn:focus-visible,
#retakeBtn:focus-visible {
  outline: 3px solid #2a5931;
  outline-offset: 3px;
}

/* ===== Responsive Design ===== */
@media (max-width: 600px) {
  main {
    padding: 32px 24px;
  }

  header h1 {
    font-size: 1.8rem;
  }

  .modal {
    padding: 24px;
  }

  .modal h2 {
    font-size: 1.4rem;
  }

  .logout-btn,
  #reportBtn {
    width: 100%;
  }
}

.button-column {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  margin-top: 24px;
}

@media (min-width: 640px) {
  .button-column {
    flex-direction: row;
    justify-content: center;
  }
}


.top-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background-color: #ffffff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 1000;
}

.logo-top-left {
  position: fixed;
  top: 16px;
  left: 10px;
  right: 10px;
  height: 24px;      /* sets height */
  object-fit: contain;
}



.logout-btn-top-right {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #f44336;
  color: white;
  padding: 10px 20px;
  font-weight: 600;
  border-radius: 9999px;
  font-size: 0.9rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: background 0.3s ease, transform 0.2s ease;
  z-index: 1000;
}

.logout-btn-top-right:hover {
  background: #d32f2f;
  transform: translateY(-2px);
}




/* Modal container smaller & compact */
/* Smaller overall font */
#incidentModal form {
  font-size: 0.85rem; /* ~13.6px instead of default 16px */
  line-height: 1.3;
}

/* Reduce spacing between inputs and labels */
#incidentModal form > div,
#incidentModal form fieldset {
  margin-bottom: 0.75rem; /* Less vertical space */
}

/* Labels */
#incidentModal label {
  margin-bottom: 0.25rem;
  font-weight: 600;
  color: #374151; /* gray-700 */
}

/* Inputs and textarea */
#incidentModal input[type="text"],
#incidentModal textarea {
  padding: 6px 8px;
  font-size: 0.85rem;
  border-radius: 4px;
  border: 1px solid #d1d5db; /* gray-300 */
  width: 100%;
  box-sizing: border-box;
}

/* Reduce textarea rows a bit */
#description {
  min-height: 60px; /* about 3 rows */
}

/* Fieldset legend */
#incidentModal fieldset legend {
  font-weight: 600;
  color: #4b5563; /* gray-600 */
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

/* Category radios: two columns, less gap */
#categoryFieldset > div {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.5rem 1rem;
}

#categoryFieldset label {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.85rem;
}

/* Buttons smaller and tighter */
#incidentModal button,
#incidentModal input[type="submit"] {
  font-size: 0.85rem;
  padding: 0.4rem 0.75rem;
  border-radius: 5px;
}

/* Modal padding and max-width */
#incidentModal .modal {
  padding: 1rem 1.25rem;
  max-width: 520px;
}

/* Adjust spacing inside upload/capture section */
#incidentModal fieldset.border {
  padding: 0.75rem 1rem;
}

#incidentModal #preview-container {
  gap: 0.4rem;
  margin-bottom: 0.5rem;
}

#incidentModal #preview-container img {
  width: 90px;
  height: auto;
  border-radius: 4px;
}

/* Reduce space around camera and buttons */
#incidentModal video#camera {
  margin-bottom: 0.5rem;
  border-radius: 4px;
}



  /* Category fieldset legend */
  #categoryFieldset legend {
    font-weight: 600;
    margin-bottom: 0.4rem;
  }
  /* Category options grid */
  #categoryFieldset > div {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.4rem 1.2rem;
  }
  /* Align label text nicely */
  #categoryFieldset label {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
  }
  #categoryFieldset input[type="radio"] {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
  }
  /* Buttons smaller */
  #incidentForm button,
  #incidentForm input[type="submit"] {
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
  }
  /* Upload buttons side by side */
  fieldset.border > div.flex {
    gap: 0.5rem;
  }
  /* Video & preview smaller */
  #camera {
    height: 150px;
  }
  #preview-container img {
    max-height: 80px;
    border-radius: 4px;
  }

.logo-top-center {
  position: fixed;
  top: 18px;
  left: 50%;
  transform: translateX(-50%);
  height: 28px;
  object-fit: contain;
  z-index: 1000;
}




  </style>
</head>
<body>
<img src="zong.png" alt="Zong Logo" class="logo-top-center">

<button id="logoutBtn" class="logout-btn-top-right">Logout</button>

<main class="max-w-3xl mx-auto px-4 py-6">
  <header class="text-center mb-5">
  <h1 class="text-lg font-semibold">Report An Incident</h1>
</header>


  <section style="font-size: 15px; color: #2e3e2f; line-height: 1.5;" class="text-left space-y-3">
  <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 0.5rem;">What Can Be Reported</h2>
  <p>This form is for reporting incidents that directly affect or disrupt sales activities. Examples include, but are not limited to:</p>

  <ul style="margin-left: 1.25rem; list-style-type: disc; margin-bottom: 1rem;">
    <li><strong>Network or service outages</strong> impacting customer experience or new activations</li>
    <li><strong>BVS device malfunctions</strong> causing disruption in transactions</li>
    <li><strong>System or portal issues</strong>, such as CRM errors or login problems</li>
    <li><strong>Power outages</strong> resulting in downtime or service interruptions</li>
    <li><strong>Law and order situations or strikes</strong> affecting safety or operations</li>
    <li><strong>Weather-related disruptions</strong> like rain, floods, or storms that impact sales activities</li>
  </ul>

  <p>Please provide detailed information when submitting an incident to help ensure a swift and effective resolution.</p>
</section>




 <div class="button-column">
  <button 
    id="reportBtn"
    class="px-5 py-3 bg-green-700 text-white text-sm font-semibold rounded-full shadow-md hover:bg-green-800 transition"
  >
    Report
  </button>
  
</div>


<div class="modal-overlay" id="incidentModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" tabindex="-1">
  <div class="modal bg-white rounded-md shadow-lg mx-auto mt-10">
    <button class="close-modal-btn text-lg float-right text-gray-500 hover:text-red-500" aria-label="Close incident report form" type="button">&times;</button>
    <h2 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-2">Incident Details</h2>
    <form id="incidentForm" action="https://docs.google.com/forms/d/e/1FAIpQLSd5c1QouFPJDmlpfPEEeevnpsUMNVPUjEjblNcMrghHYUXlhA/formResponse" method="POST" target="hidden_iframe" onsubmit="submitted=true;" novalidate>
  
  <!-- Username -->
  <div>
    <label for="username" class="block font-medium text-gray-700 mb-1">Username</label>
    <input type="text" id="username" name="entry.1634554342" readonly class="w-full border rounded bg-gray-100 text-gray-700 cursor-not-allowed" />
  </div>

  <!-- Region Dropdown -->
  <div>
    <label for="region" class="block text-sm font-medium text-gray-700 mb-1">Region</label>
    <select id="region" name="entry.25383971" required
      class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500">
      <option value="" disabled selected>Select region</option>
      <option value="Central 1">Central 1</option>
      <option value="Central 4">Central 4</option>
      <option value="Central 5">Central 5</option>
      <option value="Central 6">Central 6</option>
    </select>
  </div>

  <div>
        <label for="area" class="block font-medium text-gray-700 mb-1">Franchise ID</label>
        <input type="text" id="franchise" name="entry.1108724290" placeholder="Enter area" required aria-required="true" class="w-full border rounded focus:ring-2 focus:ring-indigo-500" />
      </div>

      <div>
        <label for="area" class="block font-medium text-gray-700 mb-1">Area Name</label>
        <input type="text" id="area" name="entry.121549873" placeholder="Enter area" required aria-required="true" class="w-full border rounded focus:ring-2 focus:ring-indigo-500" />
      </div>
  <!-- Date -->
<div class="mb-4">
  <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
  <input type="date" id="date" name="entry.328998674" required
    class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
</div>

<!-- Start and End Time in One Row -->
<div class="flex flex-row flex-nowrap gap-4 mb-4">
  <!-- Start Time -->
  <div class="w-1/2">
    <label for="starttime" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
    <input type="time" id="starttime" name="entry.2005489746" required
      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
 
    <label for="endtime" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
    <input type="time" id="endtime" name="entry.1320935756" required
      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
  </div>
</div>



  <!-- Categories -->
  <fieldset id="categoryFieldset">
  <legend>Category (select one):</legend>
  <div>
    <label><input type="radio" name="entry.1980764601" value="BVS" required> BVS</label>
    <label><input type="radio" name="entry.1980764601" value="Network"> Network / Service</label>
    <label><input type="radio" name="entry.1980764601" value="Portal"> System / Portal</label>
    <label><input type="radio" name="entry.1980764601" value="Weather"> Weather / Rain / Flood</label>
    <label><input type="radio" name="entry.1980764601" value="PowerOutage"> Power Outage</label>
    <label><input type="radio" name="entry.1980764601" value="LawandOrder"> Law & Order / Strikes</label>
    <label><input type="radio" name="entry.1980764601" value="Other"> Other</label>
  </div>
</fieldset>


  <!-- Description -->
  <div>
    <label for="description" class="block font-medium text-gray-700 mb-1">Description</label>
    <textarea id="description" name="entry.390587969" rows="3" placeholder="Describe the incident in detail" required class="w-full border rounded focus:ring-2 focus:ring-indigo-500"></textarea>
  </div>

  <!-- Upload/Capture Section -->
  <fieldset class="border p-3 rounded">
    <legend class="font-medium text-gray-700 mb-1">Upload or Capture Image(s)</legend>
    <div class="flex flex-wrap gap-2 mb-2">
      <button type="button" id="uploadImageBtn" class="bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Upload Image</button>
      <button type="button" id="openCameraBtn" class="bg-green-600 text-white rounded hover:bg-green-700 transition">Take Photo</button>
    </div>
    <input type="file" id="uploadImages" name="uploadImages" accept="image/*" multiple style="display:none;">
    <video id="camera" autoplay playsinline class="w-full rounded border mb-2"></video>
    <canvas id="snapshot" style="display:none;"></canvas>
    <div id="preview-container" class="grid grid-cols-2 gap-2 mb-2">
      <img id="preview" src="" alt="Image preview" style="display:none;" class="rounded border" />
    </div>
    <div class="flex gap-2">
      <button type="button" id="captureBtn" class="bg-gray-700 text-white rounded hover:bg-gray-800 transition">Capture Photo</button>
      <button type="button" id="retakeBtn" style="display:none;" class="bg-gray-400 text-white rounded hover:bg-gray-500 transition">Retake</button>
    </div>
  </fieldset>

  <!-- Hidden image input -->
  <input type="hidden" id="imgUrlInput" name="entry.1031277114" value="">

  <!-- Submit -->
  <button type="submit" class="w-full bg-indigo-600 text-white rounded py-2 hover:bg-indigo-700 transition">Submit Incident</button>
</form>

  </div>
</div>



      <iframe name="hidden_iframe" style="display:none;"></iframe>
    </div>
  </div>




</main>

<script>
  if (!localStorage.getItem("loggedIn")) {
    window.location.href = "index.html"; // Kick unauthorized users out
  }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {

    let imageList = []; // stores File objects and Data URLs

const reportBtn = document.getElementById("reportBtn");

const usernameInput = document.getElementById("username");
    const loggedInUser = localStorage.getItem("username") || "";
    const modal = document.getElementById("incidentModal");
    
    const closeModalBtn = modal.querySelector(".close-modal-btn");
    closeModalBtn.addEventListener("click", closeModal);

    const incidentForm = document.getElementById("incidentForm");
    const logoutBtn = document.getElementById("logoutBtn");

    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        // Optional: Clear session or localStorage if you use it for login state
        sessionStorage.clear();
        localStorage.clear();

        // Redirect to index.html
        window.location.href = "index.html";
      });
    }
    const video = document.getElementById("camera");
    const canvas = document.getElementById("snapshot");
    const captureBtn = document.getElementById("captureBtn");
    const retakeBtn = document.getElementById("retakeBtn");

    usernameInput.value = loggedInUser;

    const focusableSelectors = [
      'a[href]',
      'area[href]',
      'input:not([disabled])',
      'select:not([disabled])',
      'textarea:not([disabled])',
      'button:not([disabled])',
      'iframe',
      'object',
      'embed',
      '[contenteditable]',
      '[tabindex]:not([tabindex="-1"])'
    ];

    let lastFocusedElement = null;
    let imageDataURL = null;
    let stream = null;

    function trapFocus(event) {
      const focusableElements = modal.querySelectorAll(focusableSelectors.join(","));
      if (focusableElements.length === 0) return;

      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      if (event.key === "Tab") {
        if (event.shiftKey) {
          if (document.activeElement === firstElement) {
            event.preventDefault();
            lastElement.focus();
          }
        } else {
          if (document.activeElement === lastElement) {
            event.preventDefault();
            firstElement.focus();
          }
        }
      }
    }

    async function startCamera() {
  try {
    video.style.display = "block"; // ✅ Ensure it's visible BEFORE requesting stream

    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }

    video.srcObject = null;

    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;

  } catch (err) {
    alert("Could not access the camera. Please allow camera permissions.");
    console.error(err);
  }
}


  function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  video.srcObject = null;
}


    function openModal() {
  lastFocusedElement = document.activeElement;
  modal.classList.add("active");
  modal.setAttribute("aria-hidden", "false");
  reportBtn.setAttribute("aria-expanded", "true");

  const focusableElements = modal.querySelectorAll(focusableSelectors.join(","));
  if (focusableElements.length) {
    focusableElements[0].focus();
  }
  document.addEventListener("keydown", trapFocus);

  // ✅ Reset Upload/Capture UI
  document.getElementById("uploadImages").style.display = "none";
  document.getElementById("camera").style.display = "none";
  document.getElementById("snapshot").style.display = "none";
  document.getElementById("captureBtn").style.display = "none";
  document.getElementById("retakeBtn").style.display = "none";

  // ✅ Reset preview area
  const previewContainer = document.getElementById("preview-container");
  previewContainer.innerHTML = "";

  // ✅ Reset file input
  const fileInput = document.getElementById("uploadImages");
  fileInput.value = "";

  // ✅ Reset image list
  imageList = [];

  // ✅ Reset hidden input
  const imgUrlInput = document.getElementById("imgUrlInput");
  if (imgUrlInput) imgUrlInput.value = "";

  // ✅ Stop any camera that might be running
  stopCamera();
}


   function closeModal() {
  modal.classList.remove("active");
  modal.setAttribute("aria-hidden", "true");
  reportBtn.setAttribute("aria-expanded", "false");
  if (lastFocusedElement) lastFocusedElement.focus();
  document.removeEventListener("keydown", trapFocus);

  stopCamera();
  video.srcObject = null;
  video.style.display = 'none';

  // 🔄 Reset preview image and file input
  const preview = document.getElementById('preview');
  if (preview) {
    preview.src = '';
    preview.style.display = 'none';
  }

  const fileInput = document.getElementById('uploadImages');
  const imgUrlInput = document.getElementById("imgUrlInput");

  fileInput.value = ''; // reset the file input
  imgUrlInput.value = ''; // reset hidden input value

  // ✅ Clear preview-container of all child images
  const previewContainer = document.getElementById("preview-container");
  previewContainer.innerHTML = "";
}


     incidentForm.addEventListener("submit", async (event) => {
    event.preventDefault();

    const area = incidentForm.area.value.trim();
    const description = incidentForm.description.value.trim();
    const imgUrlInput = document.getElementById("imgUrlInput");

    if (!area || !description) {
      alert("Please fill in all required fields.");
      return;
    }

    if (imageList.length === 0) {
      alert("Please upload or capture at least one image before submitting.");
      return;
    }

    // Upload all images to ImgBB
    const uploadedUrls = [];
    for (let img of imageList) {
      let base64Image = null;

      if (typeof img === 'string') {
        base64Image = img;
      } else if (img instanceof Blob) {
        base64Image = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(img);
        });
      } else {
        alert("Unsupported image type.");
        return;
      }

      const uploadedImageUrl = await uploadToImgbb(base64Image, loggedInUser);
      if (uploadedImageUrl) {
        uploadedUrls.push(uploadedImageUrl);
      } else {
        alert("Failed to upload one or more images. Please try again.");
        return;
      }
    }

    const categoryCheckboxes = document.querySelectorAll('input[name="entry.1980764601"]:checked');
if (categoryCheckboxes.length === 0) {
  alert("Please select at least one category.");
  return;  // prevent submission
}


    // Set all URLs into hidden input
    imgUrlInput.value = uploadedUrls.join('\n');

    // Submit the form to Google Forms
    incidentForm.submit();
    alert("Incident reported successfully.");

    // Reset state
    incidentForm.reset();
    imageList = [];
    usernameInput.value = loggedInUser;
    document.getElementById('preview-container').innerHTML = '';
    closeModal();
  });


  

 function resizeImage(file, maxWidth = 800, maxHeight = 800) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = e => img.src = e.target.result;
      reader.onerror = reject;

      img.onload = () => {
        let { width, height } = img;

        if (width > height) {
          if (width > maxWidth) {
            height = Math.round(height * maxWidth / width);
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width = Math.round(width * maxHeight / height);
            height = maxHeight;
          }
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob(blob => {
          if (blob) resolve(blob);
          else reject(new Error("Canvas is empty"));
        }, 'image/jpeg', 0.7); // compress quality 0.7
      };

      reader.readAsDataURL(file);
    });
  }

  // New helper to create preview with delete button and append to preview container
  function addImagePreview(blobOrDataUrl, index) {
    const previewContainer = document.getElementById("preview-container");

    // Wrapper div for image + delete button
    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    wrapper.style.display = 'inline-block';
    wrapper.style.margin = '5px';

    const img = document.createElement("img");

    if (blobOrDataUrl instanceof Blob) {
      img.src = URL.createObjectURL(blobOrDataUrl);
    } else {
      // data URL string
      img.src = blobOrDataUrl;
    }

    img.className = "rounded border";
    img.style.width = '100px';
    img.style.height = 'auto';

    // Delete button
    // Delete button
const deleteBtn = document.createElement('button');
deleteBtn.textContent = '×';

// Styling with better visual design
Object.assign(deleteBtn.style, {
  position: 'absolute',
  top: '6px',
  right: '6px',
  background: 'rgba(0, 0, 0, 0.6)', // semi-transparent black
  color: 'white',
  border: 'none',
  borderRadius: '50%',
  width: '24px',
  height: '24px',
  cursor: 'pointer',
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'center',
  fontSize: '18px',
  fontWeight: 'bold',
  lineHeight: '1',
  boxShadow: '0 0 4px rgba(0,0,0,0.3)',
  transition: 'background-color 0.3s ease, transform 0.2s ease',
  userSelect: 'none',
  padding: '0',
});

// Hover effect (using JS because inline styles)
deleteBtn.addEventListener('mouseenter', () => {
  deleteBtn.style.background = 'rgba(0, 0, 0, 0.85)';
  deleteBtn.style.transform = 'scale(1.1)';
});

deleteBtn.addEventListener('mouseleave', () => {
  deleteBtn.style.background = 'rgba(0, 0, 0, 0.6)';
  deleteBtn.style.transform = 'scale(1)';
});

    deleteBtn.onclick = () => {
      // Remove from preview
      previewContainer.removeChild(wrapper);

      // Remove from imageList
      imageList.splice(index, 1);

      // Since indices change after removal, re-render previews
      renderPreviews();
    };

    wrapper.appendChild(img);
    wrapper.appendChild(deleteBtn);
    previewContainer.appendChild(wrapper);
  }

  // Helper to clear & re-render all previews (needed when deleting)
  function renderPreviews() {
    const previewContainer = document.getElementById("preview-container");
    previewContainer.innerHTML = '';
    imageList.forEach((imgData, i) => {
      addImagePreview(imgData, i);
    });
  }



      captureBtn.addEventListener("click", () => {
    const context = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(async (blob) => {
      try {
        const resizedBlob = await resizeImage(blob);
        // Store resized blob as object URL for upload
        imageList.push(resizedBlob);

        renderPreviews();

        // Hide canvas, show video and capture button to allow multiple captures
        canvas.style.display = "none";
        video.style.display = "block";
        captureBtn.style.display = "inline-block";
        retakeBtn.style.display = "none";
      } catch (err) {
        alert("Failed to process captured image.");
        console.error(err);
      }
    }, "image/png");
  });



    retakeBtn.addEventListener("click", () => {
      imageDataURL = null;
      video.style.display = "block";
      canvas.style.display = "none";
      captureBtn.style.display = "inline-block";
      retakeBtn.style.display = "none";
      const imgUrlInput = document.getElementById("imgUrlInput");
      if (imgUrlInput) imgUrlInput.value = "";

      startCamera();
    });


   // Helper to upload image to ImgBB and return URL
async function uploadToImgbb(base64Image, username) {
  const apiKey = '14e51e0636e117beac224a32711adc49';
  const url = `https://api.imgbb.com/1/upload?key=${apiKey}`;

  const base64 = base64Image.replace(/^data:image\/\w+;base64,/, '');
  const timestamp = new Date().toISOString().replace(/:/g, '-');
  const fileName = `${username}_${timestamp}.png`;

  const formData = new FormData();
  formData.append('image', base64);
  formData.append('name', fileName);

  try {
    const response = await fetch(url, {
      method: 'POST',
      body: formData
    });
    const result = await response.json();
    if (result.success) {
      return result.data.url;
    } else {
      throw new Error('Upload failed');
    }
  } catch (error) {
    alert("Failed to upload image: " + error.message);
    return null;
  }
}


// Show file input only when "Upload Image" is clicked
  document.getElementById("uploadImageBtn").addEventListener("click", () => {
    document.getElementById("uploadImages").style.display = "block";
    document.getElementById("camera").style.display = "none";
    document.getElementById("captureBtn").style.display = "none";
    document.getElementById("retakeBtn").style.display = "none";
    document.getElementById("snapshot").style.display = "none";
    stopCamera();
  });

  // Start camera only when "Take Photo" is clicked
  document.getElementById("openCameraBtn").addEventListener("click", () => {
    document.getElementById("uploadImages").style.display = "none";
    document.getElementById("camera").style.display = "block";
    document.getElementById("captureBtn").style.display = "inline-block";
    document.getElementById("retakeBtn").style.display = "none";
    document.getElementById("snapshot").style.display = "none";
    document.getElementById("imgUrlInput").value = "";
    startCamera();
  });
// Upload image and preview it
 document.getElementById('uploadImages').addEventListener('change', async function () {
    const files = Array.from(this.files);

    // We do NOT clear previous images, so new uploads add to list

    for (const file of files) {
      if (file && file.type.startsWith('image/')) {
        try {
          const resizedBlob = await resizeImage(file);
          imageList.push(resizedBlob);
          renderPreviews();
        } catch (err) {
          alert("Failed to process uploaded image.");
          console.error(err);
        }
      }
    }

    // Reset file input to allow uploading the same file again if needed
    this.value = "";
  });



// ✅ Add this to open the modal when button is clicked
reportBtn.addEventListener("click", openModal);

});

</script>

</body>

</html>



